import { Meta } from "storybook/blocks";

<Meta title="Governance/Commit Guard" />

# Commit Guard (view)

Commit messages are the trust signal that ties branches, PRs, changelog entries, and automation together. The commit guard hook enforces ticket prefixes so the lifecycle scripts can reconcile work across ideas, Projects, and releases without guessing.

## System of Record

- **Ticket IDs:** Idea filenames under `/ideas/` (e.g., `PB-scripts-first-lifecycle-rollout.md`)
- **Branch / PR metadata:** Derived from the ticket prefix injected by `pnpm gh:worktree`
- **Automation:** `scripts/ops/commit-msg-hook.mjs` (installed via `simple-git-hooks`)

## Command Contract

```bash
# Install hooks locally
pnpm install-hooks

# Validate an entire PR range
pnpm commit:guard -- --range origin/main..HEAD

# Re-run the validator against a message
node scripts/ops/commit-msg-hook.mjs .git/COMMIT_EDITMSG --dry-run
```

- The hook runs automatically on every commit unless `SKIP_SIMPLE_GIT_HOOKS=1`.
- Messages must start with `[ID-slug]` (e.g., `[PB-scripts-first-lifecycle-rollout] chore: update docs`).
- Merge and revert commits bypass validation; all others must pass.

## Worked Example

After branching with `pnpm gh:worktree 91 --yes`, developers commit changes with `[PB-scripts-first-lifecycle-rollout] chore: hydrate lifecycle docs`. The hook confirms the Playbook ID matches the branch ticket, enforces the space after the prefix, and warns if the slug casing drifts. Because the hook ran, the PR generator and changelog scripts can confidently map follow-up work to the same ticket without additional metadata.

## Constraints

- Keep ticket slugs lowercase; the hook warns when camelCase sneaks into `[ID-slug]`.
- Never bypass the guardrail during normal work—dry-run outputs (`--dry-run`) should accompany status notes if a validation tweak is needed.
- Preserve the `[skip ci]` suffix only after the required ticket prefix; the hook expects the prefix at column zero.
- Set `SKIP_SIMPLE_GIT_HOOKS=1` only for automation bootstrap commits (the `gh:worktree` script does this intentionally); clear it before committing real changes.
- CI runs `pnpm commit:guard`; local pushes must keep the range clean or guardrails will block the pipeline.

## Hand-off Links

- Hook Script → `/scripts/ops/commit-msg-hook.mjs`
- Lifecycle Overview → `/storybook/?path=/docs/governance-lifecycle-overview--docs`
- Playbook Pattern → `/playbook/patterns/scripts-first-lifecycle-overview.html`
- Template README → `/templates/script/README.md`
