name: pr-changelog

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: read

jobs:
  extract-changelog:
    name: Extract Changelog from PR
    runs-on: ubuntu-latest
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract changelog from PR
        id: extract
        run: |
          node scripts/ops/extract-pr-changelog.mjs \
            --pr-number ${{ github.event.pull_request.number }} \
            --yes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for summary files
        id: check
        run: |
          if [ -d "_tmp" ] && [ "$(ls -A _tmp/*.md 2>/dev/null)" ]; then
            echo "has_summaries=true" >> $GITHUB_OUTPUT
            echo "Found summary files:"
            ls -la _tmp/*.md
          else
            echo "has_summaries=false" >> $GITHUB_OUTPUT
            echo "No summary files found"
          fi

      - name: Commit summary file
        if: steps.check.outputs.has_summaries == 'true'
        run: |
          git add _tmp/*.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: add changelog summary from PR #${{ github.event.pull_request.number }} [skip ci]"
            git push origin main
          fi

      - name: Summary
        if: always()
        run: |
          echo "## PR Changelog Extraction" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Number | #${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Title | ${{ github.event.pull_request.title }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has Summaries | ${{ steps.check.outputs.has_summaries }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.has_summaries }}" = "true" ]; then
            echo "✅ Changelog summary extracted and committed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The summary will be consolidated into CHANGELOG.md during the next version bump." >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No changelog section found in PR body" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To include this PR in the changelog, add a section like:" >> $GITHUB_STEP_SUMMARY
            echo '```markdown' >> $GITHUB_STEP_SUMMARY
            echo "## Changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Your change description here" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
