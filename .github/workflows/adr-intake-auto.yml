name: ADR Intake Auto
on:
  push:
    paths: ["docs/adr/**"]
  pull_request:
    paths: ["docs/adr/**"]

jobs:
  intake:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      pull-requests: write
      project: write
    steps:
      - uses: actions/checkout@v4
      - name: Parse ADR and open Intake Card
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const glob = require('glob');
            const files = glob.sync('docs/adr/*.md');
            if (files.length === 0) {
              core.info('No ADR files found.');
              return;
            }
            files.sort((a,b)=>fs.statSync(b).mtimeMs - fs.statSync(a).mtimeMs);
            const file = files[0];
            const txt = fs.readFileSync(file,'utf8');
            const idm = txt.match(/^-\s*ADR ID:\s*([A-Z]+-[a-z0-9-]+)/mi);
            const owners = txt.match(/Owners:\s*A:@([^\s]+)\s*B:@([^\s]+)\s*C:@([^\s]+)\s*D:@([^\s]+)/i);
            const pilotm = txt.match(/Pilot unit\/pattern:\s*([^\n]+)/i);
            const stopm = txt.match(/Stop rule:\s*([^\n]+)/i);
            const adrId = idm ? idm[1] : `ARCH-unknown-${Date.now()}`;
            const a = owners ? owners[1] : 'lane-a';
            const b = owners ? owners[2] : 'lane-b';
            const c = owners ? owners[3] : 'lane-c';
            const d = owners ? owners[4] : 'lane-d';
            const title = `ADR Intake: ${adrId}`;
            const { data: issues } = await github.rest.search.issuesAndPullRequests({ q: `repo:${context.repo.owner}/${context.repo.repo} "${title}" in:title type:issue` });
            let issue;
            if (issues.items && issues.items.length) { issue = issues.items[0]; }
            const body = [
              `## Intake Hand-off (parsed)`,
              `ADR: ${file}`,
              `Pilot: ${pilotm ? pilotm[1].trim() : 'TBD'}`,
              `Owners: A:@${a} B:@${b} C:@${c} D:@${d}`,
              ``,
              `## Owners`,
              `current_owner: @${d}`,
              `next_owner: @${a}`,
              `next_lane: A`,
              ``,
              `## Acceptance Matrix (evidence URLs)`,
              `A: storybook_run= ; readme_diff= ; pr=`,
              `B: playbook_page= ; asset_note=`,
              `C: gate_comment= ; metrics_note=`,
              `D: decision_log= ; registry_commit=`,
              ``,
              `## Stop rule`,
              `${stopm ? stopm[1].trim() : 'Card by T+30m; CI p95 +90s; 2-run failure freeze'}`
            ].join('\n');
            if (!issue) { 
              const created = await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title, body, labels: ['lane:D','adr-intake']
              });
              issue = created.data;
            } else {
              await github.rest.issues.update({ owner: context.repo.owner, repo: context.repo.repo, issue_number: issue.number, body });
            }
            await github.rest.issues.addAssignees({ owner: context.repo.owner, repo: context.repo.repo, issue_number: issue.number, assignees: [a] });
            core.info(`Intake Card ready: #${issue.number}`);
